---
import { getCollection } from "astro:content";
import Layout from "@layouts/Layout.astro";
import Header from "@components/Header.astro";
import Footer from "@components/Footer.astro";
import LinkButton from "@components/LinkButton.astro";
import Hr from "@components/Hr.astro";
import Card from "@components/Card";
import PostCard from "@components/PostCard";
import Hero from "@components/Hero.astro";
import Socials from "@components/Socials.astro";
import CompanyLogos from "@components/CompanyLogos.astro";
import CalBooking from "@components/CalBooking";
import DitheredPortrait from "@components/DitheredPortrait";
import TacticalAboutEmbed from "@components/TacticalAboutEmbed";
import Newsletter from "@components/Newsletter.astro";
import getSortedPosts from "@utils/getSortedPosts";
import { SOCIALS } from "@config";
import socialIcons from "@assets/socialIcons";
import { portrait } from "@data/portrait";

const posts = await getCollection("blog");

const sortedPosts = getSortedPosts(posts);
const featuredPosts = sortedPosts.filter(({ data }) => data.featured);
const recentPosts = sortedPosts.filter(({ data }) => !data.featured);

const socialCount = SOCIALS.filter(social => social.active).length;
---

<Layout activeNav="home">
  <Header />
  <main id="main-content" class="index-main">
    <section id="hero" class="hero-section">
      <div class="hero-container">
        <div class="hero-dithered-wrapper">
          <DitheredPortrait
            client:load
            src="/assets/arach-circle.png"
            width={220}
            height={220}
            algorithm="atkinson"
            pixelSize={1}
            threshold={185}
            colorLight="#ECCF7C"
            colorDark="#0E0E0D"
            showControls={true}
          />
        </div>
        <div class="hero-content">
          <h1 class="hero-title animate-in">
            Startup Founder, Engineering Leader,<br /> and AI Enthusiast
          </h1>

          <p class="hero-description animate-in-slow">
            Hi, I'm <strong>Arach</strong>. I'm a software engineer who loves
            turning ideas into reality. From Startups to Meta, I've learned how 
            to bridge the gap between technical execution and business vision.
          </p>

          <div class="cta-buttons animate-in">
            <LinkButton href="https://arach.dev" className="cta-primary">
              Explorations
              <svg
                xmlns="http://www.w3.org/2000/svg"
                className="ml-3.5 h-4 w-4"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M14 5l7 7m0 0l-7 7m7-7H3"></path>
              </svg>
            </LinkButton>
            <CalBooking client:load />
          </div>
        </div>

        <div class="hero-image-wrapper animate-in">
          <button 
            id="hero-image-button"
            class="hero-image-container cursor-pointer transition-transform duration-200 hover:scale-110"
            aria-label="View tactical profile"
          >
            <div class="hero-image-gradient"></div>
            <img
              src="/assets/arach-circle.png"
              alt="Arach Tchoupani"
              class="hero-image"
            />
          </button>
        </div>
      </div>
    </section>
    
    <section id="agent-home" class="agent-home">
      <div class="ah-banner">
        <h1 class="ah-banner-title">Agent View</h1>
        <p class="ah-banner-desc">
          You're looking at an agent-friendly view of arach.io.
          Everything on the homepage is here — flattened for easy reading and parsing.
        </p>
        <div class="ah-banner-resources">
          <a href="/agent.md"><strong>agent.md</strong> <span>— full site content as markdown</span></a>
          <a href="/llms.txt"><strong>llms.txt</strong> <span>— structured site summary for LLMs</span></a>
          <a href="/agents"><strong>/agents</strong> <span>— agent profile and API reference</span></a>
          <a href="/agents/index.json"><strong>agents.json</strong> <span>— machine-readable data</span></a>
          <a href="/rss.xml"><strong>rss.xml</strong> <span>— subscribe to updates</span></a>
        </div>
      </div>

      <div class="ah-intro">
        <div class="ah-profile">
          <a href="/agents/author-portrait" class="ah-portrait-link">
            <pre class="ah-portrait" set:html={portrait} />
          </a>
          <div>
            <h2 class="ah-name">Arach Tchoupani</h2>
            <p class="ah-bio">
              Startup founder, engineering leader, and AI enthusiast.
              Software engineer turning ideas into reality — from startups to Meta,
              bridging the gap between technical execution and business vision.
            </p>
            <div class="ah-links">
              <a href="https://arach.dev">arach.dev</a>
              <a href="/about">About</a>
            </div>
          </div>
        </div>
      </div>

      {featuredPosts.length > 0 && (
        <div class="ah-section">
          <h2 class="ah-heading">Featured</h2>
          <ol class="ah-list">
            {featuredPosts.map(({ data, slug }) => (
              <li>
                <a href={`/posts/${slug}/`} class="ah-post-link">
                  <span class="ah-post-title">{data.title}</span>
                  <span class="ah-post-date">{new Date(data.pubDatetime).toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric" })}</span>
                </a>
                {data.description && <p class="ah-post-desc">{data.description}</p>}
              </li>
            ))}
          </ol>
        </div>
      )}

      <div class="ah-section">
        <h2 class="ah-heading">Recent</h2>
        <ol class="ah-list">
          {recentPosts.slice(0, 6).map(({ data, slug }) => (
            <li>
              <a href={`/posts/${slug}/`} class="ah-post-link">
                <span class="ah-post-title">{data.title}</span>
                <span class="ah-post-date">{new Date(data.pubDatetime).toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric" })}</span>
              </a>
              {data.description && <p class="ah-post-desc">{data.description}</p>}
            </li>
          ))}
        </ol>
        <a href="/posts/" class="ah-view-all">View all posts →</a>
      </div>

      <div class="ah-section ah-newsletter-note">
        <h2 class="ah-heading">Newsletter</h2>
        <p class="ah-bio">Subscribe for updates on engineering, startups, and AI.</p>
        <a href="#newsletter" class="ah-view-all" onclick="document.querySelector('.newsletter-section')?.scrollIntoView({behavior:'smooth'}); return false;">Subscribe →</a>
      </div>
    </section>

    <section id="companies" class="companies-section">
      <CompanyLogos />
    </section>

    {
      featuredPosts.length > 0 && (
        <>
          <section id="featured" class="content-section">
            <h2 class="section-title">
              <span class="featured-full">Featured Posts</span>
              <span class="featured-short">Featured</span>
            </h2>
            <div class="grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-3">
              {featuredPosts.map(({ data, slug }) => (
                <PostCard
                  href={`/posts/${slug}/`}
                  frontmatter={data}
                  secHeading={false}
                />
              ))}
            </div>
          </section>
          {recentPosts.length > 0 && <Hr noPadding={false} />}
        </>
      )
    }

    {
      recentPosts.length > 0 && (
        <section id="recent-posts" class="content-section">
          <h2 class="section-title">Recent Posts</h2>
          <div class="grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-3">
            {recentPosts.map(
              ({ data, slug }, index) =>
                index < 6 && (
                  <PostCard
                    href={`/posts/${slug}/`}
                    frontmatter={data}
                    secHeading={false}
                  />
                )
            )}
          </div>
        </section>
      )
    }

    <div class="all-posts-btn-wrapper">
      <LinkButton
        href="/posts/"
        className="inline-flex items-center px-6 py-3 text-base font-medium rounded-lg"
      >
        View All Posts
        <svg xmlns="http://www.w3.org/2000/svg" className="ml-2 h-5 w-5"
          ><path
            d="m11.293 17.293 1.414 1.414L19.414 12l-6.707-6.707-1.414 1.414L15.586 11H6v2h9.586z"
          ></path>
        </svg>
      </LinkButton>
    </div>

    <section id="newsletter" class="content-section newsletter-section">
      <Newsletter />
    </section>

    <Footer />
  </main>

  <!-- Tactical About Overlay -->
  <TacticalAboutEmbed client:load />

  <style>
    /* ===== Main Content ===== */
    .index-main {
      @apply w-full;
      margin-top: 3rem;
      padding-top: 0;
    }
    
    /* ===== Newsletter Section ===== */
    .newsletter-section {
      @apply py-6;
    }
    
    /* iPhone: move main content up by reducing top margin */
    @media (max-width: 767px) {
      .index-main {
        margin-top: 1.5rem;
      }
    }
    
    @media (min-width: 768px) {
      .index-main {
        margin-top: 5rem;
      }
    }

    /* ===== Hero Section ===== */
    .hero-section {
      @apply pb-12 pt-16 md:pt-20;
    }
    
    /* iPhone: move content up and minimal bottom spacing */
    @media (max-width: 767px) {
      .hero-section {
        @apply pt-10 pb-1;
      }
    }

    .hero-container {
      @apply flex flex-col gap-6 md:flex-row md:items-center md:gap-12 lg:gap-16;
    }

    .hero-content {
      @apply flex-1 pt-2;
    }
    
    /* iPhone: center all hero content */
    @media (max-width: 767px) {
      .hero-content {
        @apply text-center;
      }
    }

    .hero-title {
      @apply text-4xl font-black tracking-tighter leading-tight md:text-4xl lg:text-5xl;
    }
    
    /* Tablet: slightly smaller title for better fit */
    @media (min-width: 768px) and (max-width: 1023px) {
      .hero-title {
        @apply text-3xl;
      }
    }

    .hero-subtitle {
      @apply mt-3 text-xl text-skin-base opacity-80 sm:text-2xl;
    }

    .hero-description {
      @apply mt-6 max-w-prose font-light;
      font-size: 1.125rem;
      line-height: 1.75;
      color: rgb(var(--color-text-base) / 0.9);
    }
    
    /* Tablet: adjusted description size */
    @media (min-width: 768px) and (max-width: 1023px) {
      .hero-description {
        font-size: 1.125rem;
        line-height: 1.7;
        @apply mt-4;
      }
    }
    
    /* Desktop: larger description */
    @media (min-width: 1024px) {
      .hero-description {
        font-size: 1.375rem;
        line-height: 1.8;
      }
    }
    
    .hero-description strong {
      @apply font-black;
    }

    .cta-buttons {
      @apply mt-8 flex gap-3;
    }
    
    /* Tablet: ensure buttons don't stretch too wide */
    @media (min-width: 768px) and (max-width: 1023px) {
      .cta-buttons {
        @apply max-w-sm;
      }
    }
    
    /* Phone: force side by side layout */
    @media (max-width: 640px) {
      .cta-buttons {
        @apply gap-2;
      }
    }

    .cta-primary {
      @apply inline-flex items-center rounded-lg bg-skin-accent px-5 py-2.5 text-sm font-medium text-skin-inverted transition-opacity flex-1 justify-center;
    }
    
    /* iPhone: more compact buttons */
    @media (max-width: 767px) {
      .cta-primary {
        @apply px-3 py-2 text-xs;
      }
    }
    
    .cta-primary:hover {
      @apply bg-skin-accent text-skin-inverted;
      opacity: 0.9;
    }
    
    .cta-primary:hover svg {
      animation: slideRight 0.3s ease-out;
    }

    .cta-secondary {
      @apply inline-flex items-center rounded-lg bg-skin-card px-5 py-2.5 text-sm font-medium transition-all flex-1 justify-center;
      border: 1px solid rgb(var(--color-border));
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
    }
    
    /* iPhone: more compact secondary button */
    @media (max-width: 767px) {
      .cta-secondary {
        @apply px-3 py-2 text-xs;
      }
    }
    
    .cta-secondary:hover {
      @apply bg-skin-card-muted;
      border-color: rgb(var(--color-accent));
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .cta-secondary:hover svg {
      animation: bounceUp 0.4s ease-out;
    }
    
    html[data-theme="dark"] .cta-secondary {
      box-shadow: 0 1px 3px rgba(255, 255, 255, 0.08);
    }
    
    html[data-theme="dark"] .cta-secondary:hover {
      box-shadow: 0 4px 12px rgba(255, 255, 255, 0.15);
    }

    /* Hidden by default — Terminal template CSS reveals it */
    .hero-dithered-wrapper {
      display: none;
    }

    /* Agent home — hidden by default, shown in terminal template */
    .agent-home {
      display: none;
    }

    :global([data-agent="true"]) .agent-home {
      display: block;
      padding: 2rem 0 0.5rem;
    }

    :global([data-agent="true"]) .hero-section {
      display: none !important;
    }

    /* Hide the regular card-based sections in agent mode — agent-home replaces them */
    :global([data-agent="true"]) #featured,
    :global([data-agent="true"]) #recent-posts,
    :global([data-agent="true"]) .all-posts-btn-wrapper,
    :global([data-agent="true"]) hr {
      display: none !important;
    }

    .ah-banner {
      margin-bottom: 2rem;
      padding-bottom: 1.5rem;
      border-bottom: 1px solid rgb(var(--color-border));
    }

    .ah-banner-title {
      font-size: 1rem;
      font-weight: 600;
      letter-spacing: -0.01em;
      margin: 0 0 0.375rem;
    }

    .ah-banner-desc {
      font-size: 0.8125rem;
      line-height: 1.6;
      opacity: 0.55;
      margin: 0 0 1rem;
      max-width: 520px;
    }

    .ah-banner-resources {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .ah-banner-resources a {
      font-size: 0.8125rem;
      text-decoration: none;
      color: inherit;
      display: flex;
      align-items: baseline;
      gap: 0.375rem;
      padding: 0.25rem 0;
    }

    .ah-banner-resources a strong {
      font-weight: 600;
    }

    .ah-banner-resources a span {
      opacity: 0.4;
      font-size: 0.75rem;
    }

    .ah-banner-resources a:hover {
      text-decoration: underline;
    }

    .ah-banner-resources a:hover span {
      opacity: 0.7;
    }

    .ah-intro {
      margin-bottom: 2rem;
      padding-bottom: 1.5rem;
      border-bottom: 1px solid rgb(var(--color-border));
    }

    .ah-profile {
      display: flex;
      align-items: flex-start;
      gap: 1.25rem;
    }

    .ah-portrait-link {
      flex-shrink: 0;
      text-decoration: none !important;
      display: block;
      line-height: 0;
    }

    .ah-portrait-link:hover .ah-portrait {
      opacity: 0.7;
    }

    .ah-portrait {
      font-size: 0.3rem;
      line-height: 1.15;
      margin: 0;
      opacity: 0.45;
      color: inherit;
      transition: opacity 0.2s;
      max-width: 120px;
      overflow: hidden;
    }

    @media (max-width: 640px) {
      .ah-portrait-link {
        display: none;
      }
    }

    .ah-name {
      font-size: 1rem;
      font-weight: 600;
      letter-spacing: -0.01em;
      margin: 0 0 0.375rem;
    }

    .ah-bio {
      font-size: 0.875rem;
      line-height: 1.7;
      opacity: 0.7;
      margin: 0 0 0.75rem;
      max-width: 600px;
    }

    .ah-links {
      display: flex;
      gap: 1rem;
      font-size: 0.8125rem;
    }

    .ah-links a {
      opacity: 0.5;
      text-decoration: none;
    }

    .ah-links a:hover {
      opacity: 1;
      text-decoration: underline;
    }

    .ah-section {
      margin-bottom: 1.5rem;
      padding-bottom: 1.5rem;
      border-bottom: 1px solid rgb(var(--color-border));
    }

    .ah-section:last-child {
      border-bottom: none;
    }

    .ah-heading {
      font-size: 0.6875rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      opacity: 0.4;
      margin: 0 0 0.75rem;
    }

    .ah-list {
      list-style: none;
      counter-reset: ah-counter;
      padding: 0;
      margin: 0;
    }

    .ah-list li {
      counter-increment: ah-counter;
      padding: 0.375rem 0 0.375rem 2rem;
      position: relative;
    }

    .ah-list li::before {
      content: counter(ah-counter);
      position: absolute;
      left: 0;
      width: 1.5rem;
      text-align: right;
      font-size: 0.75rem;
      font-weight: 600;
      opacity: 0.3;
    }

    .ah-post-link {
      display: flex;
      align-items: baseline;
      gap: 0.75rem;
      text-decoration: none;
      color: inherit;
    }

    .ah-post-link:hover .ah-post-title {
      opacity: 1;
      text-decoration: underline;
    }

    .ah-post-title {
      font-size: 0.875rem;
      font-weight: 500;
      flex: 1;
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .ah-post-date {
      font-size: 0.75rem;
      opacity: 0.4;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .ah-post-desc {
      font-size: 0.75rem;
      line-height: 1.5;
      opacity: 0.45;
      margin: 0.125rem 0 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .ah-view-all {
      display: inline-block;
      margin-top: 0.75rem;
      font-size: 0.8125rem;
      opacity: 0.5;
      text-decoration: none;
    }

    .ah-view-all:hover {
      opacity: 1;
      text-decoration: underline;
    }

    .hero-image-wrapper {
      @apply flex-shrink-0;
    }
    
    /* Phone only: hide face photo to save space */
    @media (max-width: 640px) {
      .hero-image-wrapper {
        @apply hidden;
      }
    }
    
    .hero-image-container {
      @apply relative;
    }
    
    .hero-image-gradient {
      @apply absolute -inset-4 rounded-full blur-3xl opacity-70;
      background: radial-gradient(circle at center, rgb(var(--color-accent) / 0.25), rgb(var(--color-accent) / 0.05));
    }

    .hero-image {
      @apply rounded-full object-cover shadow-2xl relative;
      width: 15.4rem;
      height: 15.4rem;
      transition: transform 0.3s ease;
      border: 5px solid rgba(255, 255, 255, 0.15);
    }
    
    /* Tablet: smaller image */
    @media (min-width: 768px) and (max-width: 1023px) {
      .hero-image {
        width: 12rem;
        height: 12rem;
      }
      
      .hero-image-gradient {
        @apply -inset-3;
      }
    }

    .hero-image:hover {
      transform: scale(1.05) rotate(-5deg);
    }

    /* ===== Section Styles ===== */
    .section-title {
      @apply mb-6 text-3xl font-black tracking-tight;
    }
    
    /* Featured text responsive display */
    .featured-full {
      @apply inline;
    }
    
    .featured-short {
      @apply hidden;
    }
    
    /* iPhone: center section titles, reduce spacing, and show short text */
    @media (max-width: 767px) {
      .section-title {
        @apply text-center mb-4 mt-2;
      }
      
      .featured-full {
        @apply hidden;
      }
      
      .featured-short {
        @apply inline;
      }
    }

    .journey-content p,
    .current-content p {
      @apply mb-4 text-base leading-6;
    }

    .journey-content p:last-child,
    .current-content p:last-child {
      @apply mb-0;
    }
    
    .social-links-row {
      @apply flex flex-col items-center sm:flex-row sm:items-center sm:gap-4;
    }
    
    .social-links-row p {
      @apply sm:mb-0;
    }

    /* ===== Featured & Recent Posts Sections ===== */
    .content-section {
      @apply pb-6 pt-6;
    }
    
    #featured h2,
    #recent-posts h2 {
      @apply text-3xl font-bold tracking-tight ml-0;
    }
    .all-posts-btn-wrapper {
      @apply mt-12 mb-16 text-center;
    }

    /* Stagger children animations */
    .stagger-children > * {
      opacity: 0;
      animation: fadeIn 0.6s ease-out forwards;
    }

    .stagger-children > *:nth-child(1) {
      animation-delay: 0.1s;
    }
    .stagger-children > *:nth-child(2) {
      animation-delay: 0.2s;
    }
    .stagger-children > *:nth-child(3) {
      animation-delay: 0.3s;
    }
    .stagger-children > *:nth-child(4) {
      animation-delay: 0.4s;
    }
    .stagger-children > *:nth-child(5) {
      animation-delay: 0.5s;
    }
    .stagger-children > *:nth-child(6) {
      animation-delay: 0.6s;
    }

    
    /* ===== Companies Section ===== */
    .companies-section {
      @apply py-6 mt-6;
      background: rgb(var(--color-card-muted) / 0.3);
    }
    
    /* Dark mode: white background strip for logo visibility */
    html[data-theme="dark"] .companies-section {
      background: rgb(255, 255, 255);
      box-shadow: 0 0 0 100vmax rgb(255, 255, 255);
      clip-path: inset(0 -100vmax);
    }
    
    /* ===== Animations ===== */
    @keyframes slideRight {
      0%, 100% {
        transform: translateX(0);
      }
      50% {
        transform: translateX(3px);
      }
    }
    
    @keyframes bounceUp {
      0%, 100% {
        transform: translateY(0) rotate(0deg);
      }
      25% {
        transform: translateY(-2px) rotate(-5deg);
      }
      50% {
        transform: translateY(-3px) rotate(5deg);
      }
      75% {
        transform: translateY(-1px) rotate(-2deg);
      }
    }
    /* Hero Image Button Styles */
    button.hero-image-container {
      background: none;
      border: none;
      padding: 0;
      margin: 0;
      display: block;
      outline: none;
    }
    
    .hero-image-container:hover .hero-image {
      transform: scale(1.05) rotate(-5deg);
    }
  </style>
</Layout>
