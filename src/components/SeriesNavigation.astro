---
import type { CollectionEntry } from "astro:content";
import { getCollection } from "astro:content";

export interface Props {
  currentPost: CollectionEntry<"blog">;
}

const { currentPost } = Astro.props;

// Get all blog posts in the same series
const allPosts = await getCollection("blog");
const seriesPosts = currentPost.data.series ? allPosts
  .filter(post => 
    post.data.series?.name === currentPost.data.series?.name && 
    !post.data.draft
  )
  .sort((a, b) => (a.data.series?.order || 0) - (b.data.series?.order || 0)) : [];

const currentIndex = seriesPosts.findIndex(post => post.slug === currentPost.slug);
const previousPost = currentIndex > 0 ? seriesPosts[currentIndex - 1] : null;
const nextPost = currentIndex < seriesPosts.length - 1 ? seriesPosts[currentIndex + 1] : null;

// Only show series navigation if the current post is part of a series and series has more than one post
const showSeriesNav = currentPost.data.series && seriesPosts.length > 1;
---

{showSeriesNav && (
<>


  <!-- Series navigation sidebar -->
  <nav 
    id="series-navigation" 
    class="series-navigation" 
    aria-label={`${currentPost.data.series?.name ?? 'Series'} series navigation`}
    aria-hidden="false"
  >
    <button 
      id="series-close" 
      class="series-close" 
      aria-label="Close series navigation"
    >
      ×
    </button>
  <div class="series-header">
    <p class="series-label">Special Series</p>
    <h3 class="series-title">
      <span class="series-title-full">{currentPost.data.series?.name ?? ''}</span>
      <span class="series-title-short">SPECIAL SERIES ON AI</span>
    </h3>
    <p class="series-progress">
      Part {currentPost.data.series?.order ?? 0} of {seriesPosts.length}
    </p>
  </div>

  <div class="series-list">
    {seriesPosts.map((post, index) => {
      const isCurrent = post.slug === currentPost.slug;
      const isCompleted = index < currentIndex;
      
      // Create short titles for minimized view
      const shortTitles = {
        'ladderless-path': 'pulling up the ladder',
        'ai-restored-cto-personal-leverage': 'ai as leverage', 
        'ai-theater-vs-real-transformation': 'theater vs transformation'
      };
      
      const shortTitle = shortTitles[post.slug] || post.data.title.toLowerCase().slice(0, 20);
      
      return (
        <div class={`series-item ${isCurrent ? 'current' : ''} ${isCompleted ? 'completed' : ''}`}>
          <div class="series-number">
            <span class="series-number-full">{isCompleted ? '✓' : post.data.series?.order}</span>
            <span class="series-number-short">{post.data.series?.order}</span>
          </div>
          <div class="series-content">
            {isCurrent ? (
              <>
                <span class="series-current-title series-full-title">{post.data.title}</span>
                <span class="series-current-title series-short-title">{shortTitle}</span>
              </>
            ) : (
              <>
                <a href={`/posts/${post.slug}/`} class="series-link series-full-title">
                  {post.data.title}
                </a>
                <a href={`/posts/${post.slug}/`} class="series-link series-short-title">
                  {shortTitle}
                </a>
              </>
            )}
          </div>
        </div>
      );
    })}
  </div>

  <div class="series-navigation-buttons">
    {previousPost && (
      <a href={`/posts/${previousPost.slug}/`} class="series-nav-button prev">
        <span class="nav-direction">← Previous</span>
        <span class="nav-title">{previousPost.data.title}</span>
      </a>
    )}
    {nextPost && (
      <a href={`/posts/${nextPost.slug}/`} class="series-nav-button next">
        <span class="nav-direction">Next →</span>
        <span class="nav-title">{nextPost.data.title}</span>
      </a>
    )}
  </div>
  </nav>

  <!-- Backdrop for tablet view -->
  <div id="series-backdrop" class="series-backdrop" aria-hidden="true"></div>
</>
)}

<style>

  .series-close {
    @apply absolute top-3 right-3 w-8 h-8 
           bg-skin-card-muted hover:bg-skin-card
           rounded-full flex items-center justify-center
           text-xl font-light text-skin-base hover:text-skin-accent
           transition-colors;
    border: none;
    cursor: pointer;
  }

  .series-backdrop {
    @apply fixed inset-0 bg-black bg-opacity-50 z-20 hidden;
    transition: opacity 0.3s ease;
  }

  .series-navigation {
    @apply bg-skin-card border border-skin-line rounded-lg p-5 relative;
    /* Reset prose styles since this sits inside the article */
    color: rgb(var(--color-text-base));
    font-family: inherit;
    transition: transform 0.3s ease;
  }

  /* When collapsed on mobile, minimize spacing */
  @media (max-width: 768px) {
    .series-navigation:not(.mobile-open) {
      margin-bottom: 0 !important;
    }
  }

  /* iPhone: completely hidden by default, slide-down when open */
  @media (max-width: 767px) {
    
    
    .series-close {
      @apply hidden;
    }
    
    .series-backdrop {
      @apply hidden !important;
    }
    
    .series-navigation {
      @apply hidden w-full relative overflow-hidden;
      transform: none !important;
      transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
    }

    .series-navigation.mobile-open {
      @apply block mb-1;
      max-height: 800px; /* Large enough for content */
      opacity: 1;
    }
  }

  /* iPad/Tablet: full-width panel sliding from below header row */
  @media (min-width: 768px) and (max-width: 1024px) {
    .series-navigation {
      @apply w-full bg-skin-card border border-skin-line rounded-lg overflow-hidden;
      max-height: 0;
      opacity: 0;
      transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
    }

    .series-navigation.open {
      max-height: 600px; /* Large enough for content */
      opacity: 1;
    }

    .series-backdrop {
      @apply hidden !important;
    }

    .series-close {
      @apply hidden;
    }
  }

  /* Desktop: sticky sidebar on the left */
  @media (min-width: 1025px) {
    
    .series-close {
      @apply hidden;
    }
    
    .series-backdrop {
      @apply hidden !important;
    }
    
    .series-navigation {
      @apply fixed top-1/2 transform -translate-y-1/2 z-30 text-left;
      left: 2rem; /* Fixed on the left side */
      width: 280px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -2px rgb(0 0 0 / 0.1);
      transition: transform 0.3s cubic-bezier(0.22, 1, 0.36, 1),
                  opacity 0.3s cubic-bezier(0.22, 1, 0.36, 1);
    }

    /* Expanded state (no change needed for left positioning) */
    .series-navigation.desktop-expanded {
      /* Keep same left position */
    }

    /* Visual indicator on the right edge */
    .series-navigation::after {
      content: '';
      position: absolute;
      right: 0;
      top: 0;
      bottom: 0;
      width: 3px;
      background: linear-gradient(180deg, 
        transparent 0%,
        rgb(var(--color-accent) / 0.4) 20%,
        rgb(var(--color-accent) / 0.6) 50%,
        rgb(var(--color-accent) / 0.4) 80%,
        transparent 100%);
      pointer-events: none;
      opacity: 1;
      transition: opacity 0.3s ease;
    }

    /* Keep the indicator visible when expanded */
    .series-navigation.desktop-expanded::after {
      opacity: 1;
    }

    /* For wider screens, keep on the left edge */
    @media (min-width: 1400px) {
      .series-navigation {
        left: 2rem;
      }
    }
    
    /* On very wide screens, position relative to content */
    @media (min-width: 1800px) {
      .series-navigation {
        left: calc((100vw - 1200px) / 2 - 320px);
        left: max(2rem, calc((100vw - 1200px) / 2 - 320px));
      }
    }
  }

  .series-header {
    @apply mb-4;
  }

  .series-label {
    @apply text-xs font-medium text-skin-accent opacity-80 mb-2 uppercase tracking-wider;
  }

  .series-title {
    @apply text-lg font-semibold text-skin-accent mb-1;
    font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', monospace;
    letter-spacing: 0.05em;
    text-transform: uppercase;
  }

  .series-progress {
    @apply text-sm text-skin-base opacity-70;
  }

  /* Mobile font size improvements */
  @media (max-width: 767px) {
    .series-label {
      @apply text-sm font-medium text-skin-accent opacity-80 mb-2 uppercase tracking-wider;
    }

    .series-title {
      @apply text-xl font-semibold text-skin-accent mb-1;
      font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', monospace;
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }

    .series-progress {
      @apply text-base text-skin-base opacity-70;
    }

    .series-link {
      @apply text-skin-base hover:text-skin-accent transition-colors text-lg line-clamp-2;
    }

    .series-current-title {
      @apply text-skin-accent font-medium text-lg line-clamp-2;
    }

    .nav-title {
      @apply block text-sm text-skin-base line-clamp-2;
    }
  }

  .series-list {
    @apply space-y-2 mb-4;
    transition: opacity 0.3s ease, transform 0.3s ease;
  }

  /* Default: show full titles and numbers */
  .series-title-short,
  .series-short-title,
  .series-number-short {
    position: absolute;
    opacity: 0;
    pointer-events: none;
  }

  .series-title-full,
  .series-full-title,
  .series-number-full {
    opacity: 1;
  }

  /* Desktop collapsed vs expanded behavior */
  @media (min-width: 1025px) {
    /* Collapsed: show short titles and compact UI */
    .series-navigation.desktop-collapsed {
      width: 240px;
      padding-top: 0.75rem;
      padding-bottom: 0.75rem;
    }

    .series-navigation.desktop-collapsed .series-label,
    .series-navigation.desktop-collapsed .series-progress,
    .series-navigation.desktop-collapsed .series-navigation-buttons {
      opacity: 0;
      height: 0;
      margin: 0;
      padding: 0;
      overflow: hidden;
      pointer-events: none;
    }

    .series-navigation.desktop-collapsed .series-title-full,
    .series-navigation.desktop-collapsed .series-full-title,
    .series-navigation.desktop-collapsed .series-number-full {
      position: absolute;
      opacity: 0;
      pointer-events: none;
    }

    .series-navigation.desktop-collapsed .series-title-short,
    .series-navigation.desktop-collapsed .series-short-title,
    .series-navigation.desktop-collapsed .series-number-short {
      position: static;
      opacity: 1;
      pointer-events: auto;
    }

    /* Expanded: show full titles; hide short versions */
    .series-navigation.desktop-expanded .series-title-full,
    .series-navigation.desktop-expanded .series-full-title,
    .series-navigation.desktop-expanded .series-number-full,
    .series-navigation.desktop-expanded .series-label,
    .series-navigation.desktop-expanded .series-progress,
    .series-navigation.desktop-expanded .series-navigation-buttons {
      opacity: 1;
      height: auto;
      pointer-events: auto;
    }

    .series-navigation.desktop-expanded .series-title-short,
    .series-navigation.desktop-expanded .series-short-title,
    .series-navigation.desktop-expanded .series-number-short {
      position: absolute;
      opacity: 0;
      pointer-events: none;
    }
  }
  
  /* Content transitions happen after container expansion (with delay) */
  .series-label,
  .series-progress,
  .series-navigation-buttons,
  .series-title span,
  .series-link,
  .series-current-title {
    transition: opacity 0.4s cubic-bezier(0.22, 1, 0.36, 1) 0.3s, /* Delayed by 0.3s */
                height 0.4s cubic-bezier(0.22, 1, 0.36, 1) 0.3s,
                margin 0.4s cubic-bezier(0.22, 1, 0.36, 1) 0.3s,
                padding 0.4s cubic-bezier(0.22, 1, 0.36, 1) 0.3s;
  }
  
  /* Numbers fade quickly */
  .series-number {
    transition: opacity 0.3s ease;
  }

  /* Desktop styles - always expanded */
  @media (min-width: 1025px) {
    /* Always show full content on desktop */
    .series-navigation .series-label,
    .series-navigation .series-progress {
      opacity: 1;
      height: auto;
      pointer-events: auto;
    }
    
    .series-navigation .series-navigation-buttons {
      opacity: 1;
      height: auto;
      pointer-events: auto;
    }
  }

  .series-item {
    @apply flex items-start gap-3 p-3 rounded-md transition-colors;
  }

  .series-item.current {
    @apply bg-skin-accent bg-opacity-10;
  }

  .series-item.completed {
    @apply opacity-75;
  }

  .series-number {
    @apply flex-shrink-0 w-6 h-6 rounded-full bg-skin-accent bg-opacity-20 flex items-center justify-center text-xs font-medium;
  }

  .series-item.current .series-number {
    @apply bg-skin-accent text-skin-inverted;
  }

  .series-item.completed .series-number {
    @apply bg-green-500 text-white;
  }

  .series-content {
    @apply flex-1 min-w-0;
  }

  .series-link {
    @apply text-skin-base hover:text-skin-accent transition-colors text-base line-clamp-2;
    text-decoration: none;
  }

  .series-link:hover {
    @apply underline;
  }

  .series-current-title {
    @apply text-skin-accent font-medium text-base line-clamp-2;
  }

  .series-navigation-buttons {
    @apply flex gap-2 pt-3 border-t border-skin-line;
  }

  .series-nav-button {
    @apply flex-1 p-2 rounded-md border border-skin-line hover:bg-skin-card-muted transition-colors;
    text-decoration: none;
  }

  .series-nav-button.next {
    @apply text-right;
  }

  .nav-direction {
    @apply block text-xs font-medium text-skin-accent mb-1;
  }

  .nav-title {
    @apply block text-xs text-skin-base line-clamp-2;
  }

  .series-nav-button:hover .nav-title {
    @apply text-skin-accent;
  }

  /* Mobile responsiveness */
  @media (max-width: 640px) {
    .series-navigation-buttons {
      @apply flex-col;
    }
    
    .series-nav-button.next {
      @apply text-left;
    }
  }
</style>

<script>
  function isIPhone() {
    return window.innerWidth <= 767;
  }

  function isTablet() {
    return window.innerWidth >= 768 && window.innerWidth <= 1024;
  }

  function initIPhoneToggle() {
    if (!isIPhone()) return;

    const inlineTag = document.getElementById('series-floating-tag-inline') as (HTMLElement & { _seriesToggle?: (e: MouseEvent) => void }) | null;
    const nav = document.getElementById('series-navigation') as HTMLElement | null;
    const chevron = document.querySelector('.series-chevron') as HTMLElement | null;

    if (!inlineTag || !nav) {
      console.warn('SeriesNav: iPhone - Missing elements', { inlineTag: !!inlineTag, nav: !!nav });
      return;
    }

    function toggleMobilePanel(event: MouseEvent) {
      if (!nav) return;
      event?.preventDefault();
      event?.stopPropagation();
      
      console.log('🔥 SERIES NAV TAP - iPhone', {
        timestamp: new Date().toLocaleTimeString(),
        windowWidth: window.innerWidth,
        currentClasses: nav.className,
        chevronTransform: chevron?.style.transform || 'none'
      });
      
      const wasOpen = nav.classList.contains('mobile-open');
      
      // NUCLEAR RESET - clear everything
      nav.classList.remove('mobile-open', 'open');
      nav.setAttribute('aria-hidden', 'true');
      if (chevron) chevron.style.transform = 'rotate(0deg)';
      
      // Force reflow
      nav.offsetHeight;
      
      if (!wasOpen) {
        nav.classList.add('mobile-open');
        nav.setAttribute('aria-hidden', 'false');
        if (chevron) chevron.style.transform = 'rotate(180deg)';
        console.log('✅ iPhone navigation OPENED');
      } else {
        console.log('❌ iPhone navigation CLOSED');
      }
    }

    // Clean up any existing listeners
    if (inlineTag && inlineTag._seriesToggle) {
      inlineTag.removeEventListener('click', inlineTag._seriesToggle);
    }
    
    if (inlineTag) {
      inlineTag._seriesToggle = toggleMobilePanel;
      inlineTag.addEventListener('click', toggleMobilePanel);
    }
    console.log('📱 iPhone toggle initialized');
  }

  function initTabletToggle() {
    if (!isTablet()) return;

    const inlineTag = document.getElementById('series-floating-tag-inline') as (HTMLElement & { _seriesToggle?: (e: MouseEvent) => void }) | null;
    const nav = document.getElementById('series-navigation') as HTMLElement | null;
    const chevron = document.querySelector('.series-chevron') as HTMLElement | null;

    if (!inlineTag || !nav) {
      console.warn('SeriesNav: iPad - Missing elements', { inlineTag: !!inlineTag, nav: !!nav });
      return;
    }

    function toggleExpansion(event: MouseEvent) {
      if (!nav) return;
      event?.preventDefault();
      event?.stopPropagation();
      
      console.log('🔥 SERIES NAV TAP - iPad', {
        timestamp: new Date().toLocaleTimeString(),
        windowWidth: window.innerWidth,
        currentClasses: nav.className,
        chevronTransform: chevron?.style.transform || 'none'
      });
      
      const wasOpen = nav.classList.contains('open');
      
      // NUCLEAR RESET - clear everything
      nav.classList.remove('open', 'mobile-open');
      nav.setAttribute('aria-hidden', 'true');
      if (chevron) chevron.style.transform = 'rotate(0deg)';
      
      // Force reflow
      nav.offsetHeight;
      
      if (!wasOpen) {
        nav.classList.add('open');
        nav.setAttribute('aria-hidden', 'false');
        if (chevron) chevron.style.transform = 'rotate(180deg)';
        console.log('✅ iPad navigation OPENED');
      } else {
        console.log('❌ iPad navigation CLOSED');
      }
    }

    // Clean up any existing listeners
    if (inlineTag && inlineTag._seriesToggle) {
      inlineTag.removeEventListener('click', inlineTag._seriesToggle);
    }
    
    if (inlineTag) inlineTag._seriesToggle = toggleExpansion;

    // Event listeners
    inlineTag.addEventListener('click', toggleExpansion);

    // ESC key to close
    document.addEventListener('keydown', (e: KeyboardEvent) => {
      if (e.key === 'Escape' && nav.classList.contains('open')) {
        nav.classList.remove('open');
        nav.setAttribute('aria-hidden', 'true');
      }
    });

    // Close on outside click
    document.addEventListener('click', (e: MouseEvent) => {
      const target = e.target as Node | null;
      if (nav.classList.contains('open') && 
          !(nav as Node).contains(target) && 
          inlineTag && !(inlineTag as Node).contains(target)) {
        nav.classList.remove('open');
        nav.setAttribute('aria-hidden', 'true');
      }
    });
  }

  // Desktop - always visible on left
  function initDesktopInteraction() {
    if (window.innerWidth < 1025) return;

    const nav = document.getElementById('series-navigation') as HTMLElement | null;
    if (!nav) return;

    // Default to collapsed with short titles
    nav.classList.add('desktop-collapsed');
    nav.classList.remove('desktop-expanded');

    // Expand on hover/focus
    function expand() {
      if (!nav) return;
      nav.classList.add('desktop-expanded');
      nav.classList.remove('desktop-collapsed');
    }

    function collapse() {
      if (!nav) return;
      nav.classList.add('desktop-collapsed');
      nav.classList.remove('desktop-expanded');
    }

    nav.addEventListener('mouseenter', expand);
    nav.addEventListener('focusin', expand);
    nav.addEventListener('mouseleave', collapse);
    nav.addEventListener('focusout', (e: FocusEvent) => {
      // Collapse if focus moves outside the nav
      const related = e.relatedTarget as Node | null;
      if (!related || !nav.contains(related)) {
        collapse();
      }
    });
  }

  // Initialize when DOM is ready
  function initAllToggles() {
    initIPhoneToggle();
    initTabletToggle();
    initDesktopInteraction();
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initAllToggles);
  } else {
    initAllToggles();
  }

  // NUCLEAR RESET on window resize - fixes stuck states
  let resizeTimeout: number | undefined;
  window.addEventListener('resize', () => {
    clearTimeout(resizeTimeout);
    resizeTimeout = window.setTimeout(() => {
      const currentWidth = window.innerWidth;
      console.log('🔄 WINDOW RESIZE - Resetting series nav state', { 
        newWidth: currentWidth,
        timestamp: new Date().toLocaleTimeString()
      });
      
      const nav = document.getElementById('series-navigation') as HTMLElement | null;
      const backdrop = document.getElementById('series-backdrop') as HTMLElement | null;
      const chevron = document.querySelector('.series-chevron') as HTMLElement | null;
      const inlineTag = document.getElementById('series-floating-tag-inline') as (HTMLElement & { _seriesToggle?: (e: MouseEvent) => void }) | null;
      
      if (!nav) return;
      
      // NUCLEAR RESET - clear everything
      nav.classList.remove('mobile-open', 'open', 'desktop-collapsed', 'desktop-expanded');
      nav.setAttribute('aria-hidden', 'false');
      nav.style.transform = '';
      nav.style.opacity = '';
      nav.style.maxHeight = '';
      
      if (backdrop) {
        backdrop.classList.remove('show');
        document.body.style.overflow = '';
      }
      if (chevron) {
        chevron.style.transform = 'rotate(0deg)';
      }
      
      // Clean up event listeners completely
      if (inlineTag && inlineTag._seriesToggle) {
        inlineTag.removeEventListener('click', inlineTag._seriesToggle);
        delete inlineTag._seriesToggle;
      }
      
      // Force reflow
      nav.offsetHeight;
      
      console.log('🧹 State reset complete - reinitializing for current breakpoint');
      
      // Re-initialize for current breakpoint
      setTimeout(() => {
        initAllToggles();
      }, 100);
    }, 300);
  });

  // THEME CHANGE HANDLER - fixes broken listeners after theme switch
  function observeThemeChanges() {
    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (mutation.type === 'attributes' && mutation.attributeName === 'data-theme') {
          console.log('🎨 THEME CHANGED - Reinitializing series navigation');
          
          // Short delay to let theme change settle
          setTimeout(() => {
            const inlineTag = document.getElementById('series-floating-tag-inline') as (HTMLElement & { _seriesToggle?: (e: MouseEvent) => void }) | null;
            if (inlineTag && inlineTag._seriesToggle) {
              console.log('🔧 Cleaning up old listeners after theme change');
              inlineTag.removeEventListener('click', inlineTag._seriesToggle);
              delete inlineTag._seriesToggle;
            }
            
            initAllToggles();
            console.log('✨ Series navigation reinitialized after theme change');
          }, 200);
        }
      });
    });
    
    observer.observe(document.documentElement, { attributes: true });
  }

  // Start observing theme changes
  observeThemeChanges();
</script>